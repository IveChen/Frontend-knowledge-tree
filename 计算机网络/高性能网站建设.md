# 高性能网站建设

### 规则1：减少http请求

- 使用CSS Sprites将多幅图片合并为一幅单独的图片。可以有效的减少HTTP请求，同时还会减少下载量。实际上合并后的图片会比分离的图片总和要小，因为它降低了图片自身的开销，如颜色表、格式信息等。
- 合并脚本和样式表。

### 规则2：使用内容发布网络

如果应用程序WEB服务器离用户更近，则一个http请求的响应时间将缩短。另一方面，如果组件WEB服务器离用户更近，则多个HTTP请求的响应时间将缩短。
内容分发网络（CDN）是一组分布在多个不同位置的WEB服务器，用于更加有效的向用户发布内容。

- CDN带来的优势除了缩短响应时间，还有备份服务，扩展存储能力和进行缓存等。但是依赖CDN的缺点是，响应时间可能受到其他网站流量的影响。
- CDN用于发布静态内容，如图片、脚本、样式表、和Flash。

### 规则3：添加Expires头

浏览器（和代理）使用缓存来减少HTTP请求的数量，并减少HTTP响应的大小，是WEB页面加载得更快。

```http
Expires: Mon, 15 Apr 2024 20:00:00 GMT。
```

使用Cache-Cantrol:max-age=?指令指定组件被缓存多久。它以秒为单位定义了一个更新窗。如果从组件被请求开始过去的秒数少于max-age，浏览器就使用缓存的版本，从而避免了额外的HTTP请求。一个长久的Expire头可以将刷新窗设置为未来的10年。
但是有时为了访问网站的用户能够及时的获取最新版本的组件，可以通过修改其页面的所有链接（使用全新的组件文件名，可以将版本号嵌入组件文件名中来达到更新文件名的效果），这样，全新的请求将从原始服务器下载最新的内容。

### 规则4：压缩组件

从HTTP1.1开始，Web客户端可以通过HTTP请求中Accept-Encoding来表示对压缩的支持–>Accept-Encoding:gzip,deflate。如果Web服务器看到请求中有这个头，就会使用客户端列出来的方法中的一种来压缩响应–>Content-Encoding:gzip。

### 规则5：将样式表放在顶部

将样式表放在文档底部会导致浏览器阻止内容逐步呈现。为避免当样式变化时重绘页面中的元素，浏览器会阻塞内容的逐步呈现。在浏览器和用户等待位于底部的样式表时，浏览器会延迟显示任何可视化组件。即显示为“白屏”（还有“无样式内容的CSS闪烁”的情况）。

### 规则6：将脚本放在底部

将脚本文件从页面顶部放于底部，可以使页面逐步呈现，也可以提高下载的并行度。使用脚本时，所有位于脚本以下的内容，逐步呈现都被阻塞了。
HTTP1.1规范建议浏览器从每个主机名并行的下载两个组件。一般推荐4个左右的并行下载数量。因为增加并行下载数量并不是没有开销的，其优劣取决于你的带宽和CPU速度，过多的并行下载反而会导致降低性能。

虽然并行下载组件的优点是很明显的。然而，在下载脚本时并行下载实际上是被禁用的————即使使用了不同的主机名，浏览器也不会启动其他的下载。其中一个原因是，脚本可能使用document.write来修改页面内容，因此浏览器会等待，以确保页面能够恰当的布局。另一个原因是为了保证脚本能够按照正确的顺序执行。例如，后面的脚本可能比较小，反而会首先执行。如果它们之间存在依赖关系，不按照顺序加载会导致JavaScript错误。

### 规则7：避免CSS表达式

CSS的频繁求值导致其底下的性能。
为了避免该低下的性能可以使用一次性表达式或者事件处理器来完成同样的功能。

### 规则8：使用外部JavaScript和CSS

外联样式和脚本会带来多个额外的HTTP请求开销。如果是包含动态内容的HTML文档————通常不会被配置为可以进行缓存。所以这种情况下，外部的样式和脚本，浏览器可以缓存它们，且HTML文档的大小减小，而且不会增加HTTP请求的数量。
如何取决依赖三个因素：页面浏览量、空缓存VS完整缓存、组件重用。

- 每个用户产生的页面浏览量越少，则每次访问之间，缓存就越可能过期而从浏览器中移除，则更推荐内联。
- 如果网站能够为用户带来高完整缓存率，使用外联的收益就更大。
- JavaScript和CSS外部文件边界相关的决定影响组件的重用程度。

### 规则9：减少DNS查找

DNS也是开销。通常浏览器查找一个给定主机名的IP地址要花费20~120毫秒。在DNS查找完成之前，浏览器不能从主机名那里下载到任何东西。
DNS查找可以被缓存起来提高性能。首先，服务器可以表明DNS记录可以被缓存多久。查找返回的DNS记录包含了一个存活时间值（TTL，Time-to-live）。该值可以告诉客户端可以对该记录缓存多久。
但是尽管操作系统会考虑TTL值，但浏览器通常忽略该值，并设置它自己的时间限制。此外，HTTP协议中的Keep-Alive特性可以同时覆盖TTL和浏览器的时间限制。也就是说，只要浏览器和Web服务器在愉快的通信中，并保持TCP连接打开的状态，就没有理由进行DNS查找。Keep-Alive通过重用现有连接避免了重复的DNS查找，避免了TCP/IP开销来减少响应时间。
可以通过减少唯一主机名的数量来减少DNS查找的数量从而降低响应时间，但同时也会潜在的减少页面中并行下载的数量。

### 规则10：精简JavaScript

精简（Minification）是从代码中移除不必要的字符，比如所有的注释和不必要的空白字符，以减少其大小，进而改善加载时间的实践。
混淆（Obfuscation）是可以应用在源代码上的一种优化方式。通过移除注释和空白，同时还会改写代码，将函数和变量的名字转换为更短的字符串。通常这样做是为了增加对代码进行反向工程的难度，但也对提高性能有帮助。

### 规则11：避免重定向

当Web服务器向浏览器返回一个重定向时，响应中就会拥有一个范围在3xx的状态码。这表示用户代理必须执行进一步的操作才能完成请求。

- 300 Multiple Choices（基于Content-Type）
- 301 Moved Permancently
- 302 Moved Temporarily（或称Found）
- 303 See Other（对302的说明）
- 304 Not Modified
- 305 Use Proxy
- 307 Temporary Redirect（对302的说明）

304并不是真的重定向，它用来响应条件GET请求，避免下载已经存在于浏览器缓存中的数据。
状态码301、302是使用的最多的。

```http
HTTP 1.1 301 Moved Permanently
Location: http://iamygj.com/high-performance-website
Content-Type:text/html
```

浏览器会自动将用户带到Location字段所给出的URL。
重定向会损伤性能，使用户体验变慢。在重定向完毕并且HTML文档下载完毕之前，没有任何东西显示给用户。

### 规则12：删除重复脚本

重复脚本损伤性能的方式有两种————不必要的HTTP请求和执行JavaScript所浪费的时间。

### 规则13：配置Etag

实体标签（Entity Tag，ETag）是Web服务器和浏览器用于确认缓存组件有效性的一种机制。
ETag是唯一标识了一个组件的一个特定版本的字符串。如果浏览器必须、验证一个组件，他会使用If-None-Match头将之前获取的ETag传回原始服务器，如果ETag匹配，则返回304状态码。

### 规则14：使Ajax可缓存

用户是否需要等待的关键因素在于Ajax请求是被动的还是主动的。
改善主动Ajax请求最重要的方式就是使响应可缓存。其中最重要的改善方法是添加Expires头。